# SmarterOJ 协作功能设计文档

> 版本：v1.0  
> 日期：2026-01-23  
> 状态：待开发

---

## 一、功能概述

为 SmarterOJ 系统增加实时协作能力，支持用户在**房间**内进行：

| 功能 | 描述 |
|------|------|
| **房间聊天** | 多人实时文字交流，支持历史消息查看 |
| **协同编辑** | 多人共同编写代码，实时同步编辑内容 |

---

## 二、核心决策

| 决策点 | 选择 | 说明 |
|--------|------|------|
| 冲突解决 | **简单广播** | 后发覆盖，后期预留 OT/CRDT 扩展接口 |
| 代码存储 | **Redis 临时存储** | 仅在协作期间存在，用户主动提交才写入 `question_submit` |
| 服务拆分 | **独立微服务** | 新建 `jc-smarteroj-backend-collaboration-service` |

---

## 三、技术选型

### 3.1 通信协议栈

```
┌─────────────────────────────────────┐
│           应用层协议                 │
│   STOMP (Simple Text Oriented       │
│   Messaging Protocol)               │
├─────────────────────────────────────┤
│           传输层协议                 │
│   WebSocket (RFC 6455)              │
└─────────────────────────────────────┘
```

**选择理由**：
- STOMP 提供发布/订阅模型，天然适合"房间"概念
- Spring Boot 原生支持，开发效率高
- 原生 WebSocket 性能更优，现代浏览器均已支持

### 3.2 消息广播

- **Redis Pub/Sub**：解决多实例部署的消息同步问题

### 3.3 数据存储

| 数据类型 | 存储位置 | 说明 |
|----------|----------|------|
| 聊天消息 | MySQL (`ws_message`) | 持久化，支持历史查询 |
| 协作代码 | Redis | 临时存储，房间关闭后自动过期 |
| 在线用户 | Redis Set | 实时维护房间成员列表 |

---

## 四、系统架构

### 4.1 整体架构

```
                        ┌─────────────────────────────────┐
                        │       Spring Cloud Gateway      │
                        │   HTTP: /api/** → 业务服务       │
                        │   WS:   /ws/** → 协作服务        │
                        └───────────────┬─────────────────┘
                                        │
        ┌───────────────────────────────┼───────────────────────────────┐
        │                               │                               │
        ▼                               ▼                               ▼
┌───────────────┐           ┌───────────────────────┐          ┌───────────────┐
│ User Service  │◄─────────►│ Collaboration Service │◄────────►│Question Svc   │
│               │   Feign   │      (新增)           │  Feign   │               │
└───────────────┘           └───────────┬───────────┘          └───────────────┘
                                        │
                            ┌───────────┴───────────┐
                            │                       │
                            ▼                       ▼
                     ┌───────────┐           ┌───────────┐
                     │   Redis   │           │   MySQL   │
                     │ (代码缓存) │           │ (消息持久) │
                     └───────────┘           └───────────┘
```

### 4.2 Gateway 路由配置

```yaml
spring:
  cloud:
    gateway:
      routes:
        # WebSocket 路由
        - id: collaboration-ws
          uri: lb:ws://jc-smarteroj-backend-collaboration-service
          predicates:
            - Path=/ws/**
        
        # REST API 路由（房间管理）
        - id: collaboration-api
          uri: lb://jc-smarteroj-backend-collaboration-service
          predicates:
            - Path=/api/collab/**
```

---

## 五、数据库设计

### 5.1 现有表（复用）

| 表名 | 用途 |
|------|------|
| `room` | 房间基础信息（名称、密码、人数上限等） |
| `user_room` | 用户-房间关联关系 |
| `ws_message` | 聊天消息持久化 |

### 5.2 Redis 数据结构

| Key 格式 | 类型 | 说明 | 过期时间 |
|----------|------|------|----------|
| `room:{roomId}:code` | String | 当前协作代码内容 | 房间关闭后 24h |
| `room:{roomId}:language` | String | 当前编程语言 | 同上 |
| `room:{roomId}:users` | Set | 在线用户 ID 集合 | 无（主动维护） |
| `room:{roomId}:cursors` | Hash | 用户光标位置（可选功能） | 同上 |

---

## 六、消息协议设计

### 6.1 STOMP 端点

| 端点 | 说明 |
|------|------|
| `/ws` | WebSocket 连接入口（原生 WebSocket） |

### 6.2 订阅目的地（Subscribe）

| 目的地 | 用途 |
|--------|------|
| `/topic/room.{roomId}.chat` | 接收房间聊天消息 |
| `/topic/room.{roomId}.code` | 接收代码变更通知 |
| `/topic/room.{roomId}.event` | 接收房间事件（加入/离开/踢出等） |
| `/user/queue/errors` | 接收个人错误消息 |

### 6.3 发送目的地（Send）

| 目的地 | 用途 |
|--------|------|
| `/app/room.{roomId}.chat` | 发送聊天消息 |
| `/app/room.{roomId}.code` | 发送代码变更 |
| `/app/room.{roomId}.join` | 加入房间 |
| `/app/room.{roomId}.leave` | 离开房间 |

### 6.4 消息格式

#### 聊天消息
```json
{
  "type": "CHAT",
  "roomId": 123,
  "userId": 456,
  "userName": "张三",
  "content": "你好！",
  "timestamp": 1706000000000
}
```

#### 代码变更消息
```json
{
  "type": "CODE_UPDATE",
  "roomId": 123,
  "userId": 456,
  "content": "public class Main { ... }",
  "language": "java",
  "version": 15,
  "timestamp": 1706000000000
}
```

> **扩展预留**：`version` 字段为后续 OT 算法预留，当前版本仅作为日志追踪使用。

#### 房间事件消息
```json
{
  "type": "USER_JOIN | USER_LEAVE | USER_KICK | ROOM_CLOSE",
  "roomId": 123,
  "userId": 456,
  "userName": "张三",
  "timestamp": 1706000000000
}
```

---

## 七、核心流程

### 7.1 用户加入房间

```
┌────────┐      ┌─────────┐      ┌───────────────┐      ┌───────┐
│ Client │      │ Gateway │      │ Collab Service│      │ Redis │
└───┬────┘      └────┬────┘      └───────┬───────┘      └───┬───┘
    │                │                   │                  │
    │ WS Connect     │                   │                  │
    │───────────────►│                   │                  │
    │                │ Forward           │                  │
    │                │──────────────────►│                  │
    │                │                   │                  │
    │ STOMP CONNECT  │                   │                  │
    │───────────────────────────────────►│                  │
    │                │                   │ 验证 Token        │
    │                │                   │                  │
    │ SUBSCRIBE      │                   │                  │
    │ /topic/room.123│                   │                  │
    │───────────────────────────────────►│                  │
    │                │                   │                  │
    │ SEND           │                   │                  │
    │ /app/room.123.join                 │                  │
    │───────────────────────────────────►│                  │
    │                │                   │ SADD users       │
    │                │                   │─────────────────►│
    │                │                   │                  │
    │                │                   │ GET code         │
    │                │                   │─────────────────►│
    │                │                   │◄─────────────────│
    │                │                   │                  │
    │◄───────────────────────────────────│ 返回当前代码快照  │
    │                │                   │                  │
    │                │                   │ 广播 USER_JOIN   │
    │◄───────────────────────────────────│                  │
    └                └                   └                  └
```

### 7.2 代码同步流程

```
User A                  Collab Service               Redis               User B
  │                          │                         │                    │
  │ 编辑代码                  │                         │                    │
  │ SEND code_update         │                         │                    │
  │─────────────────────────►│                         │                    │
  │                          │ SET room:123:code       │                    │
  │                          │────────────────────────►│                    │
  │                          │                         │                    │
  │                          │ PUBLISH to channel      │                    │
  │                          │────────────────────────►│                    │
  │                          │                         │                    │
  │                          │ Broadcast to /topic     │                    │
  │                          │─────────────────────────────────────────────►│
  │                          │                         │                    │
  └                          └                         └                    └
```

### 7.3 提交代码流程

```
┌────────┐          ┌───────────────┐          ┌───────────────┐
│ Client │          │ Collab Service│          │Question Service│
└───┬────┘          └───────┬───────┘          └───────┬───────┘
    │                       │                          │
    │ POST /api/collab/     │                          │
    │ room/{id}/submit      │                          │
    │──────────────────────►│                          │
    │                       │ Feign: 创建提交记录       │
    │                       │─────────────────────────►│
    │                       │                          │ 写入 question_submit
    │                       │◄─────────────────────────│
    │◄──────────────────────│ 返回提交 ID               │
    └                       └                          └
```

---

## 八、接口设计

### 8.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/collab/room` | 创建房间 |
| GET | `/api/collab/room/{id}` | 获取房间信息 |
| GET | `/api/collab/room/{id}/members` | 获取房间成员列表 |
| POST | `/api/collab/room/{id}/join` | 加入房间（验证密码） |
| POST | `/api/collab/room/{id}/leave` | 离开房间 |
| POST | `/api/collab/room/{id}/submit` | 提交当前代码到判题 |
| GET | `/api/collab/room/{id}/messages` | 获取历史聊天记录 |
| DELETE | `/api/collab/room/{id}` | 关闭房间（仅房主） |

### 8.2 Feign 客户端

#### 调用 User Service
- 获取用户信息（用于显示用户名、头像）

#### 调用 Question Service
- 获取题目信息（关联题目时）
- 提交代码进行判题

---

## 九、安全设计

### 9.1 鉴权方案

采用 **STOMP Headers 鉴权**：

1. 客户端在 STOMP CONNECT 时携带 Token
2. 后端拦截器验证 Token，提取用户信息
3. 验证失败立即断开连接

### 9.2 权限控制

| 操作 | 权限要求 |
|------|----------|
| 创建房间 | 登录用户 |
| 加入公开房间 | 登录用户 |
| 加入私密房间 | 登录用户 + 正确密码 |
| 发送消息/代码 | 房间成员 |
| 踢出成员 | 房主 |
| 关闭房间 | 房主 |
| 提交代码 | 房间成员 |

---

## 十、扩展预留

### 10.1 OT 算法扩展点

当前采用简单广播策略，为后续 OT 算法预留以下扩展点：

```
┌─────────────────────────────────────────────────────┐
│              ConflictResolver (接口)                │
├─────────────────────────────────────────────────────┤
│ + resolve(operation, currentDoc): Operation         │
└─────────────────────────────────────────────────────┘
                         ▲
          ┌──────────────┴──────────────┐
          │                             │
┌─────────────────────┐     ┌─────────────────────┐
│ SimpleResolver      │     │ OTResolver          │
│ (当前实现：直接返回) │     │ (后期实现：OT 转换) │
└─────────────────────┘     └─────────────────────┘
```

代码变更消息已预留 `version` 字段，用于后续 OT 版本追踪。

### 10.2 光标同步（可选）

预留 Redis Key `room:{roomId}:cursors`，后期可实现实时光标位置同步。

### 10.3 代码回放（可选）

可扩展 `ws_message` 存储代码变更记录，实现协作过程回放功能。

---

## 十一、模块目录结构

```
jc-smarteroj-backend-collaboration-service/
├── pom.xml
└── src/main/java/fun/javierchen/collaboration/
    ├── CollaborationApplication.java
    │
    ├── config/
    │   ├── WebSocketConfig.java           # WebSocket + STOMP 配置
    │   ├── RedisConfig.java               # Redis 配置
    │   └── SecurityConfig.java            # 安全配置
    │
    ├── websocket/
    │   ├── StompEventListener.java        # 连接/断开事件监听
    │   ├── AuthChannelInterceptor.java    # STOMP 鉴权拦截器
    │   └── MessageBroadcaster.java        # Redis Pub/Sub 消息广播
    │
    ├── controller/
    │   ├── RoomController.java            # 房间管理 REST API
    │   ├── ChatController.java            # 聊天 STOMP 处理
    │   └── CodeController.java            # 代码同步 STOMP 处理
    │
    ├── service/
    │   ├── RoomService.java               # 房间业务逻辑
    │   ├── ChatService.java               # 聊天业务逻辑
    │   ├── CodeService.java               # 代码同步逻辑
    │   └── resolver/
    │       ├── ConflictResolver.java      # 冲突解决接口（扩展点）
    │       └── SimpleResolver.java        # 简单实现
    │
    ├── model/
    │   ├── dto/                           # 数据传输对象
    │   ├── entity/                        # 数据库实体
    │   └── enums/                         # 枚举类
    │
    ├── mapper/
    │   ├── RoomMapper.java
    │   ├── UserRoomMapper.java
    │   └── WsMessageMapper.java
    │
    └── feign/
        ├── UserServiceClient.java         # 用户服务远程调用
        └── QuestionServiceClient.java     # 题目服务远程调用
```

---

## 十二、开发计划

| 阶段 | 任务 | 预计工时 |
|------|------|----------|
| **第一阶段** | 搭建模块骨架、配置 Gateway 路由 | 0.5 天 |
| **第二阶段** | 实现 WebSocket 连接与鉴权 | 1 天 |
| **第三阶段** | 实现房间聊天功能 | 1 天 |
| **第四阶段** | 实现协同编辑（简单广播） | 1.5 天 |
| **第五阶段** | 对接 Question Service 实现提交 | 0.5 天 |
| **第六阶段** | 测试与联调 | 1 天 |

**总计：约 5.5 天**

---

## 十三、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 高并发下 Redis 压力 | 性能下降 | 代码更新采用节流（throttle），200ms 内合并 |
| WebSocket 连接中断 | 数据丢失 | 前端自动重连 + 进入房间时拉取最新快照 |
| 多实例消息不同步 | 部分用户收不到消息 | 使用 Redis Pub/Sub 确保跨实例广播 |

---

## 附录：数据库表结构（现有）

```sql
-- 房间表
CREATE TABLE room (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    room_name   VARCHAR(256) NOT NULL,
    description VARCHAR(1024) NOT NULL,
    mate_num    TINYINT NOT NULL,
    user_id     BIGINT NOT NULL,
    status      TINYINT DEFAULT 0 NOT NULL,
    password    VARCHAR(256) DEFAULT NULL,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP,
    is_delete   TINYINT DEFAULT 0
);

-- 用户-房间关联表
CREATE TABLE user_room (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id     BIGINT NOT NULL,
    room_id     BIGINT NOT NULL,
    join_time   DATETIME,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP,
    is_delete   TINYINT DEFAULT 0
);

-- 消息表
CREATE TABLE ws_message (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id     BIGINT NOT NULL,
    room_id     BIGINT NOT NULL,
    message_id  BIGINT NOT NULL,
    content     TEXT NOT NULL,
    status      TINYINT DEFAULT 0 NOT NULL,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    INDEX idx_room_time (room_id, create_time),
    UNIQUE KEY uk_msg_id (message_id)
);
```
