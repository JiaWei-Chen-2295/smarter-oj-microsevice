# Sentinel 接口限流与黑名单规划方案

> **文档版本**: v1.0  
> **创建日期**: 2026-01-30  
> **作者**: JavierChen

---

## 一、方案概述

### 1.1 背景与目标

| 接口类型         | 敏感原因                         | 风险场景               | 限流维度     |
| ---------------- | -------------------------------- | ---------------------- | ------------ |
| **发短信接口**   | 调用第三方短信服务产生费用       | 恶意刷接口导致费用激增 | **以 IP 为主** |
| **判题接口**     | 消耗计算资源，调用 Judge0 有限额 | 恶意提交拖垮判题队列   | **以用户为主** |
| **题目查询接口** | 数据库查询压力，数据资产         | 爬虫批量抓取题库数据   | **以 IP 为主** |

### 1.2 技术选型

采用 **阿里巴巴 Sentinel** 作为流量治理框架（已集成于 Spring Cloud Alibaba 技术栈）

---

## 二、接口限流策略

### 2.1 短信发送接口（以 IP 为主）

| 配置项         | 值                        | 说明                     |
| -------------- | ------------------------- | ------------------------ |
| **资源名**     | `POST:/api/user/sms/send` |                          |
| **全局 QPS**   | 10/s                      | 短信通道整体吞吐上限     |
| **单 IP 限流** | 5次/60秒                  | 同一 IP 1分钟内最多5次   |
| **单手机号**   | 1次/60秒                  | 同一手机号1分钟内1次     |
| **熔断策略**   | 异常比例 > 50% 时熔断10秒 | 短信通道异常时自动降级   |

### 2.2 判题接口（以用户为主）

| 配置项           | 值                                      | 说明                                |
| ---------------- | --------------------------------------- | ----------------------------------- |
| **资源名**       | `POST:/api/question/question_submit/do` |                                     |
| **全局 QPS**     | **100/s**                               | 实测 131 QPS，保守取 100            |
| **单用户限流**   | 3次/10秒                                | 用户提交冷却，防止刷题攻击          |
| **并发线程数**   | 15                                      | 限制判题服务并发处理数              |
| **熔断策略**     | 慢调用比例 > 30% (RT>2s) 触发熔断       | Judge0 响应过慢时降级               |

### 2.3 题目查询接口（以 IP 为主）

| 配置项            | 值                                | 说明                          |
| ----------------- | --------------------------------- | ----------------------------- |
| **资源名 (列表)** | `POST:/api/question/list/page/vo` |                               |
| **资源名 (详情)** | `GET:/api/question/get/vo`        |                               |
| **全局 QPS**      | **80/s**                          | 实测 27 QPS，取 3 倍余量      |
| **单 IP 限流**    | 20次/分钟                         | 防止爬虫高频抓取              |
| **降级策略**      | 返回缓存数据                      | 题目列表使用热点缓存          |

---

## 三、黑名单策略

### 3.1 黑名单类型（仅两种）

| 类型           | 触发条件                 | 封禁时长 | 解封方式     |
| -------------- | ------------------------ | -------- | ------------ |
| **临时黑名单** | 1小时内触发限流 ≥ 3次    | 30分钟   | 自动解封     |
| **永久黑名单** | 进入临时黑名单 ≥ 3次     | 永久     | 人工审核解封 |

### 3.2 黑名单维度

| 接口类型       | 黑名单维度 | 说明                       |
| -------------- | ---------- | -------------------------- |
| 短信接口       | IP         | 封禁恶意 IP                |
| 题目查询接口   | IP         | 封禁爬虫 IP                |
| 判题接口       | 用户 ID    | 封禁恶意用户               |

### 3.3 黑名单存储设计（Nacos + 布隆过滤器）

| 组件           | 职责             | 实现要点                                         |
| -------------- | ---------------- | ------------------------------------------------ |
| **Nacos配置**  | 存储黑名单IP列表 | 格式：`["1.2.3.4", "5.6.7.8/24"]`（支持CIDR）    |
| **配置监听器** | 监听变更事件     | `@NacosConfigListener` + 异步重建机制            |
| **布隆过滤器** | 高效查询         | Guava BloomFilter + 预设10万容量/0.1%误判率      |
| **原子替换**   | 线程安全更新     | `AtomicReference<BloomFilter<String>>`           |

**Nacos 配置示例**：
```json
{
  "ipBlacklist": ["1.2.3.4", "10.0.0.0/8", "192.168.1.100"],
  "userBlacklist": ["user_12345", "user_67890"]
}
```

---

## 四、实现架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端请求                               │
└──────────────────────────────┬──────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Gateway 网关层                              │
│  ├─ IP 黑名单检查 Filter                                        │
│  ├─ 全局限流 (Sentinel)                                         │
│  └─ 路由级限流 (按服务)                                          │
└──────────────────────────────┬──────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                      微服务层                                    │
│  ├─ User Service     → 短信限流 (IP维度)                        │
│  ├─ Question Service → 查询限流 (IP维度) + 提交限流 (用户维度)   │
│  └─ Judge Service    → 判题限流 (用户维度)                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、规则配置

### 5.1 Gateway 层（基于压测数据）

| 规则类型    | 资源名             | 阈值      | 依据                    |
| ----------- | ------------------ | --------- | ----------------------- |
| 路由限流    | `user-service`     | 200 QPS   | 短信接口低频，余量充足  |
| 路由限流    | `question-service` | **150 QPS** | 实测 27+131 ≈ 160       |
| 路由限流    | `judge-service`    | **100 QPS** | 提交接口实测 131 QPS    |

### 5.2 Service 层（基于压测数据）

| 服务     | 资源名             | 规则类型   | 阈值      | 依据                       |
| -------- | ------------------ | ---------- | --------- | -------------------------- |
| User     | `sendSmsCaptcha`   | 热点(IP)   | 5/60s     | 短信费用保护               |
| Question | `listQuestion`     | 热点(IP)   | **20/min**| 实测 27 QPS，单 IP 限频    |
| Question | `doQuestionSubmit` | 热点(user) | **3/10s** | 防止单用户刷题             |
| Judge    | `doJudge`          | 并发线程   | **15**    | 保护 Judge0 资源           |

---

## 六、实施计划

| 阶段 | 内容                               | 工期  |
| ---- | ---------------------------------- | ----- |
| 1    | Sentinel 基础集成 + Dashboard 部署 | 1天   |
| 2    | Gateway 层限流 + IP 黑名单         | 1天   |
| 3    | 短信/题目接口限流 (IP维度)         | 1天   |
| 4    | 判题接口限流 (用户维度)            | 1天   |
| 5    | 规则持久化到 Nacos                 | 0.5天 |

---

## 七、降级响应格式

```json
{
  "code": 429,
  "message": "请求过于频繁，请稍后重试",
  "data": null
}
```

---


---

## 八、压测结果总结 (基于 wrk/wrk2)

> **测试时间**: 2026-01-30  
> **测试环境**: 本地混合部署 (Gateway + Question Service + MySQL + Redis)  
> **并发参数**: 10 线程, 100 连接  

| 接口名称 | 请求方式 | 路径 | 压测 QPS | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **题目列表** | POST | `/api/question/list/page/vo` | **27.16** | 包含数据库分页查询 |
| **题目提交** | POST | `/api/question/submit` | **131.02** | 涉及异步判题逻辑 |
| **题目详情** | GET | `/api/question/get/vo` | **24.11** | 已登录鉴权状态 |
| **未授权访问**| GET | `/api/question/get/vo` | **3229.02** | 触发网关层 Sa-Token 快速拦截 |

### 结果分析
1. **列表查询与详情查询**: QPS 在 25-30 左右，由于本地开发环境数据库连接与序列化开销，此数值为 Sentinel 初始限流阈值提供了实测参考（建议初始阈值设为实测值的 2-3 倍，即 100 QPS 左右）。
2. **提交接口**: 吞吐量表现较好，达到 130+ QPS。
3. **网关拦截**: 未经授权的请求由网关直接拦截，不消耗后端业务资源，表现出极高的吞吐能力 (3000+ QPS)。

---

> **注意**: 具体参数需根据实际生产环境资源规格进行二次调整。
